{"version":3,"sources":["server.ts"],"names":[],"mappings":"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","file":"server.js","sourcesContent":["/*\n\n             Http.Server\n                  |\n      'connection' 'request' --- 'close', ...\n                  |\n               Executor\n           /              \\\n   SessionExecutor   RequestExecutor\n          |                |\n     Controller      ControllerMethod\n          |                |\n           \\              /\n            |            |\n            +------------+\n                  |\n         Controller Dispatcher\n\n*/\n\nimport {Socket, AddressInfo} from 'net'\nimport {IncomingMessage, ServerResponse, Server, createServer} from 'http'\nimport {Scope, ProviderKey, Provider, ProviderInstance, ProviderContainer, DependencyContainer, NodeDispatcher} from '@webnode/cdi'\nimport {ApplicationContext, SessionIdentifier, RequestIdentifier} from '@webnode/cdi'\nimport {HttpError} from './error'\nimport {ServerConfig} from './config'\nimport {Registry} from './registry'\nimport {RequestExecutor} from './executor'\n\nexport class HttpServer {\n  public static create(config?: ServerConfig): HttpServer {\n    return new HttpServer(config)\n  }\n\n  private context = new ApplicationContext()\n  private nodeDispatcher: NodeDispatcher = new NodeDispatcher(\n      ProviderContainer.instance, DependencyContainer.instance, this.context)\n  private config: ServerConfig\n  private server: Server = createServer()\n  private closed: boolean = true\n\n  constructor(config?: ServerConfig) {\n    if (typeof config !== 'object' || config === null) {\n      config = Object.create(null)\n    }\n    this.config = config\n  }\n\n  public registerProvider(scope: Scope, key: ProviderKey, provider: Provider) {\n    ProviderContainer.instance.set(scope, key, provider)\n  }\n\n  public unregisterProvider(scope: Scope, key: ProviderKey) {\n    ProviderContainer.instance.delete(scope, key)\n  }\n\n  public getApplicationScopeProviderInstance(key: ProviderKey): ProviderInstance {\n    return this.context.getProviderInstanceContainerOfApplicationLocal().get(key)\n  }\n\n  public hasApplicationScopeProviderInstance(key: ProviderKey): boolean {\n    return this.context.getProviderInstanceContainerOfApplicationLocal().has(key)\n  }\n\n  public getSessionScopeProviderInstance(key: ProviderKey, sessionIdent: SessionIdentifier): ProviderInstance {\n    return this.context.getProviderInstanceContainerOfSessionLocal(sessionIdent).get(key)\n  }\n\n  public hasSessionScopeProviderInstance(key: ProviderKey, sessionIdent: SessionIdentifier): ProviderInstance {\n    return this.context.getProviderInstanceContainerOfSessionLocal(sessionIdent).has(key)\n  }\n\n  public getRequestScopeProviderInstance(key: ProviderKey, sessionIdent: SessionIdentifier, requestIdent: RequestIdentifier): ProviderInstance {\n    return this.context.getProviderInstanceContainerOfRequestLocal(sessionIdent, requestIdent).get(key)\n  }\n\n  public hasRequestScopeProviderInstance(key: ProviderKey, sessionIdent: SessionIdentifier, requestIdent: RequestIdentifier): ProviderInstance {\n    return this.context.getProviderInstanceContainerOfRequestLocal(sessionIdent, requestIdent).has(key)\n  }\n\n  public async serve() {\n    let hostname = '127.0.0.1'\n    let port = 0\n    if (typeof this.config.hostname === 'string') {\n      hostname = this.config.hostname\n    }\n    if (typeof this.config.port === 'number') {\n      port = this.config.port\n    }\n    if (typeof this.config.keepAliveTimeout === 'number') {\n      this.server.keepAliveTimeout = this.config.keepAliveTimeout\n    }\n    if (typeof this.config.timeout === 'number') {\n      this.server.timeout = this.config.timeout\n    }\n    this.server.on('connection', (connection) => this.prepareSessionContext(connection))\n    this.server.on('request', (req, res) => new RequestExecutor(req, res, this.nodeDispatcher, Registry.instance, this.config).exec())\n    this.server.on('close', () => this.closed = true)\n    this.prepareApplicationContext()\n    await new Promise((complete, fail) => this.server.listen(port, hostname, complete))\n    this.closed = false\n  }\n\n  public async close() {\n    await new Promise((complete, fail) => this.server.close(complete))\n  }\n\n  public address(): AddressInfo {\n    return this.server.address() as AddressInfo\n  }\n\n  private prepareApplicationContext() {\n    this.nodeDispatcher.createApplicationContext()\n    for (let node of Registry.instance.valuesOfEventNodes()) {\n      this.nodeDispatcher.createInstanceOnApplicationLocal(node) \n    }\n  }\n\n  private prepareSessionContext(connection: Socket) {\n    let session = this.nodeDispatcher.createSessionContext()\n    for (let node of Registry.instance.valuesOfRouteNodes()) {\n      this.nodeDispatcher.createInstanceOnSessionLocal(node, session) // Controller Node Instance 一定只有一个\n    }\n    (connection as any).__session__ = session\n    connection.on('close', () => this.nodeDispatcher.destroySessionContext(session))\n  }\n}\n\n"]}