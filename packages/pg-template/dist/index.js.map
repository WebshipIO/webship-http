{"version":3,"sources":["index.ts"],"names":[],"mappings":";;;;;;;;;;AAAA,4CAA2C;AAG3C,MAAsB,UAAU;IAC9B,YAAsB,IAAU;QAAV,SAAI,GAAJ,IAAI,CAAM;IAChC,CAAC;CACF;AAHD,gCAGC;AAkBD,MAAa,mBAAoB,SAAQ,GAA+E;IAG/G,MAAM,KAAK,QAAQ;QACxB,IAAI,mBAAmB,CAAC,SAAS,KAAK,SAAS,EAAE;YAC/C,mBAAmB,CAAC,SAAS,GAAG,IAAI,mBAAmB,EAAE,CAAA;SAC1D;QACD,OAAO,mBAAmB,CAAC,SAAS,CAAA;IACtC,CAAC;IAEM,SAAS;QACd,KAAK,IAAI,CAAC,SAAS,EAAE,GAAG,CAAC,IAAI,KAAK,CAAC,OAAO,EAAE,EAAE;YAC5C,KAAK,IAAI,CAAC,GAAG,EAAE,KAAK,CAAC,IAAI,GAAG,CAAC,OAAO,EAAE,EAAE;gBACtC,QAAQ,KAAK,CAAC,IAAI,EAAE;oBACpB,KAAK,OAAO;wBACV,IAAI,OAAO,KAAK,CAAC,GAAG,KAAK,QAAQ,EAAE;4BACjC,KAAK,CAAC,EAAE,GAAG,OAAO,CAAC,GAAG,CAAC,SAAS,CAAC,SAAS,EAAE,GAAG,CAAC,CAAA;4BAChD,OAAO,CAAC,cAAc,CAAC,SAAS,CAAC,SAAS,EAAE,GAAG,EAAE;gCAC/C,KAAK,EAAE,UAAgB,GAAG,IAAW;;wCACnC,IAAI,MAAM,GAAG,MAAM,IAAI,CAAC,IAAI,CAAC,KAAK,CAAC,cAAc,CAAC,SAAS,CAAE,KAAyB,CAAC,GAAG,EAAE,IAAI,CAAC,CAAC,CAAA;wCAClG,OAAO,OAAO,KAAK,CAAC,MAAM,KAAK,UAAU,CAAC,CAAC,CAAC,KAAK,CAAC,MAAM,CAAC,MAAM,CAAC,CAAC,CAAC,CAAC,MAAM,CAAA;oCAC3E,CAAC;iCAAA;6BACF,CAAC,CAAA;yBACH;wBACD,MAAK;oBACP,KAAK,aAAa;wBAChB,IAAI,OAAO,KAAK,CAAC,GAAG,KAAK,QAAQ,EAAE;4BACjC,KAAK,CAAC,EAAE,GAAG,OAAO,CAAC,GAAG,CAAC,SAAS,CAAC,SAAS,EAAE,GAAG,CAAC,CAAA;4BAChD,OAAO,CAAC,cAAc,CAAC,SAAS,CAAC,SAAS,EAAE,GAAG,EAAE;gCAC/C,KAAK,EAAE,UAAgB,GAAG,IAAW;;wCACnC,IAAI,UAAU,GAAG,MAAM,IAAI,CAAC,IAAI,CAAC,OAAO,EAAE,CAAA;wCAC1C,IAAI,MAAM,GAAuB,EAAE,CAAA;wCACnC,IAAI,IAAI,GAAG,cAAc,CAAC,SAAS,CAAC,KAAK,CAAC,GAAG,EAAE,IAAI,CAAC,CAAC,KAAK,CAAC,GAAG,CAAC,CAAC,MAAM,CAAC,CAAC,CAAC,EAAE,CAAC,CAAC,CAAC,IAAI,EAAE,CAAC,MAAM,GAAG,CAAC,CAAC,CAAA;wCAChG,IAAI;4CACF,MAAM,UAAU,CAAC,KAAK,CAAC,OAAO,CAAC,CAAA;4CAC/B,KAAK,IAAI,CAAC,IAAI,IAAI,EAAE;gDAClB,IAAI,CAAC,GAAG,MAAM,UAAU,CAAC,KAAK,CAAC,CAAC,CAAC,CAAA;gDACjC,MAAM,CAAC,IAAI,CAAC,CAAC,CAAC,CAAA;6CACf;4CACD,MAAM,UAAU,CAAC,KAAK,CAAC,QAAQ,CAAC,CAAA;yCACjC;wCAAC,OAAO,CAAC,EAAE;4CACV,MAAM,UAAU,CAAC,KAAK,CAAC,UAAU,CAAC,CAAA;4CAClC,MAAM,CAAC,CAAA;yCACR;gDAAS;4CACR,UAAU,CAAC,OAAO,EAAE,CAAA;yCACrB;wCACD,OAAO,OAAO,KAAK,CAAC,MAAM,KAAK,UAAU,CAAC,CAAC,CAAE,KAA+B,CAAC,MAAM,CAAC,MAAM,CAAC,CAAC,CAAC,CAAC,MAAM,CAAA;oCACtG,CAAC;iCAAA;6BACF,CAAC,CAAA;yBACH;wBACD,MAAK;iBACN;aACF;SACF;IACH,CAAC;IAEM,WAAW;QAChB,KAAK,IAAI,CAAC,SAAS,EAAE,GAAG,CAAC,IAAI,KAAK,CAAC,OAAO,EAAE,EAAE;YAC5C,KAAK,IAAI,CAAC,GAAG,EAAE,KAAK,CAAC,IAAI,GAAG,CAAC,OAAO,EAAE,EAAE;gBACtC,QAAQ,KAAK,CAAC,IAAI,EAAE;oBACpB,KAAK,OAAO;wBACV,IAAI,OAAO,KAAK,CAAC,GAAG,KAAK,QAAQ,EAAE;4BACjC,OAAO,CAAC,cAAc,CAAC,SAAS,CAAC,SAAS,EAAE,GAAG,EAAE;gCAC/C,KAAK,EAAE,KAAK,CAAC,EAAE;6BAChB,CAAC,CAAA;yBACH;wBACD,MAAK;oBACP,KAAK,aAAa;wBAChB,IAAI,OAAO,KAAK,CAAC,GAAG,KAAK,QAAQ,EAAE;4BACjC,OAAO,CAAC,cAAc,CAAC,SAAS,CAAC,SAAS,EAAE,GAAG,EAAE;gCAC/C,KAAK,EAAE,KAAK,CAAC,EAAE;6BAChB,CAAC,CAAA;yBACH;wBACD,MAAK;iBACN;aACF;SACF;IACH,CAAC;CACF;AA9ED,kDA8EC;AAED,SAAgB,KAAK,CAAC,GAAW;IAC/B,OAAO,UAAU,MAAkB,EAAE,WAAwB;QAC3D,IAAI,SAAS,GAAG,MAAM,CAAC,WAA8B,CAAA;QACrD,IAAI,CAAC,mBAAmB,CAAC,QAAQ,CAAC,GAAG,CAAC,SAAS,CAAC,EAAE;YAChD,mBAAmB,CAAC,QAAQ,CAAC,GAAG,CAAC,SAAS,EAAE,IAAI,GAAG,EAAE,CAAC,CAAA;SACvD;QACD,IAAI,CAAC,mBAAmB,CAAC,QAAQ,CAAC,GAAG,CAAC,SAAS,CAAC,CAAC,GAAG,CAAC,WAAW,CAAC,EAAE;YACjE,mBAAmB,CAAC,QAAQ,CAAC,GAAG,CAAC,SAAS,CAAC,CAAC,GAAG,CAAC,WAAW,EAAE;gBAC3D,IAAI,EAAE,OAAO;gBACb,GAAG,EAAE,GAAG;aACT,CAAC,CAAA;SACH;aAAM;YACL,mBAAmB,CAAC,QAAQ,CAAC,GAAG,CAAC,SAAS,CAAC,CAAC,GAAG,CAAC,WAAW,CAAC,CAAC,GAAG,GAAG,GAAG,CAAA;SACvE;IACH,CAAC,CAAA;AACH,CAAC;AAfD,sBAeC;AAED,SAAgB,WAAW,CAAI,MAA6B;IAC1D,OAAO,UAAU,MAAc,EAAE,WAAwB;QACvD,IAAI,SAAS,GAAG,MAAM,CAAC,WAA8B,CAAA;QACrD,IAAI,CAAC,mBAAmB,CAAC,QAAQ,CAAC,GAAG,CAAC,SAAS,CAAC,EAAE;YAChD,mBAAmB,CAAC,QAAQ,CAAC,GAAG,CAAC,SAAS,EAAE,IAAI,GAAG,EAAE,CAAC,CAAA;SACvD;QACD,IAAI,CAAC,mBAAmB,CAAC,QAAQ,CAAC,GAAG,CAAC,SAAS,CAAC,CAAC,GAAG,CAAC,WAAW,CAAC,EAAE;YACjE,mBAAmB,CAAC,QAAQ,CAAC,GAAG,CAAC,SAAS,CAAC,CAAC,GAAG,CAAC,WAAW,EAAE;gBAC3D,IAAI,EAAE,OAAO;gBACb,MAAM,EAAE,MAAM;aACf,CAAC,CAAA;SACH;aAAM;YACL,mBAAmB,CAAC,QAAQ,CAAC,GAAG,CAAC,SAAS,CAAC,CAAC,GAAG,CAAC,WAAW,CAAC,CAAC,MAAM,GAAG,MAAM,CAAA;SAC7E;IACH,CAAC,CAAA;AACH,CAAC;AAfD,kCAeC;AAED,SAAgB,WAAW,CAAC,GAAW;IACrC,OAAO,UAAU,MAAc,EAAE,WAAwB;QACvD,IAAI,SAAS,GAAG,MAAM,CAAC,WAA8B,CAAA;QACrD,IAAI,CAAC,mBAAmB,CAAC,QAAQ,CAAC,GAAG,CAAC,SAAS,CAAC,EAAE;YAChD,mBAAmB,CAAC,QAAQ,CAAC,GAAG,CAAC,SAAS,EAAE,IAAI,GAAG,EAAE,CAAC,CAAA;SACvD;QACD,IAAI,CAAC,mBAAmB,CAAC,QAAQ,CAAC,GAAG,CAAC,SAAS,CAAC,CAAC,GAAG,CAAC,WAAW,CAAC,EAAE;YACjE,mBAAmB,CAAC,QAAQ,CAAC,GAAG,CAAC,SAAS,CAAC,CAAC,GAAG,CAAC,WAAW,EAAE;gBAC3D,IAAI,EAAE,aAAa;gBACnB,GAAG,EAAE,GAAG;aACT,CAAC,CAAA;SACH;aAAM;YACL,mBAAmB,CAAC,QAAQ,CAAC,GAAG,CAAC,SAAS,CAAC,CAAC,GAAG,CAAC,WAAW,CAAC,CAAC,GAAG,GAAG,GAAG,CAAA;SACvE;IACH,CAAC,CAAA;AACH,CAAC;AAfD,kCAeC;AAED,SAAgB,iBAAiB,CAAI,MAA4C;IAC/E,OAAO,UAAU,MAAc,EAAE,WAAwB;QACvD,IAAI,SAAS,GAAG,MAAM,CAAC,WAA8B,CAAA;QACrD,IAAI,CAAC,mBAAmB,CAAC,QAAQ,CAAC,GAAG,CAAC,SAAS,CAAC,EAAE;YAChD,mBAAmB,CAAC,QAAQ,CAAC,GAAG,CAAC,SAAS,EAAE,IAAI,GAAG,EAAE,CAAC,CAAA;SACvD;QACD,IAAI,CAAC,mBAAmB,CAAC,QAAQ,CAAC,GAAG,CAAC,SAAS,CAAC,CAAC,GAAG,CAAC,WAAW,CAAC,EAAE;YACjE,mBAAmB,CAAC,QAAQ,CAAC,GAAG,CAAC,SAAS,CAAC,CAAC,GAAG,CAAC,WAAW,EAAE;gBAC3D,IAAI,EAAE,aAAa;gBACnB,MAAM,EAAE,MAAM;aACf,CAAC,CAAA;SACH;aAAM;YACL,mBAAmB,CAAC,QAAQ,CAAC,GAAG,CAAC,SAAS,CAAC,CAAC,GAAG,CAAC,WAAW,CAAC,CAAC,MAAM,GAAG,MAAM,CAAA;SAC7E;IACH,CAAC,CAAA;AACH,CAAC;AAfD,8CAeC","file":"index.js","sourcesContent":["import * as PostgresFormat from 'pg-format'\nimport {Pool, Connection, QueryResult} from 'pg'\n\nexport abstract class Repository {\n  constructor(protected pool: Pool) {\n  }\n}\n\nexport type RepositoryClass = new(...args: Array<any>) => Repository\n\nexport interface QueryProperties {\n  type: 'query'\n  sql?: string\n  filter?: (r: QueryResult) => any\n  fn?: (...args: Array<any>) => any\n}\n\nexport interface TransactionProperties {\n  type: 'transcation'\n  sql?: string\n  filter?: (r: ReadonlyArray<QueryResult>) => any\n  fn?: (...args: Array<any>) => any\n}\n\nexport class PgTemplateContainer extends Map<RepositoryClass, Map<PropertyKey, QueryProperties | TransactionProperties>> {\n  private static sInstance: PgTemplateContainer\n\n  public static get instance(): PgTemplateContainer {\n    if (PgTemplateContainer.sInstance === undefined) {\n      PgTemplateContainer.sInstance = new PgTemplateContainer()\n    }\n    return PgTemplateContainer.sInstance\n  }\n\n  public transform() {\n    for (let [classType, map] of super.entries()) {\n      for (let [key, value] of map.entries()) {\n        switch (value.type) {\n        case 'query':\n          if (typeof value.sql === 'string') {\n            value.fn = Reflect.get(classType.prototype, key)\n            Reflect.defineProperty(classType.prototype, key, {\n              value: async function (...args: any[]) {\n                let result = await this.pool.query(PostgresFormat.withArray((value as QueryProperties).sql, args))\n                return typeof value.filter === 'function' ? value.filter(result) : result\n              }\n            })\n          }\n          break\n        case 'transcation':\n          if (typeof value.sql === 'string') {\n            value.fn = Reflect.get(classType.prototype, key)\n            Reflect.defineProperty(classType.prototype, key, {\n              value: async function (...args: any[]) {\n                let connection = await this.pool.connect()\n                let result: Array<QueryResult> = []\n                let sqls = PostgresFormat.withArray(value.sql, args).split(';').filter(x => x.trim().length > 0)\n                try {\n                  await connection.query('BEGIN')\n                  for (let s of sqls) {\n                    let a = await connection.query(s)\n                    result.push(a)\n                  }\n                  await connection.query('COMMIT')\n                } catch (e) {\n                  await connection.query('ROLLBACK')\n                  throw e\n                } finally {\n                  connection.release()\n                }\n                return typeof value.filter === 'function' ? (value as TransactionProperties).filter(result) : result\n              }\n            })\n          }\n          break\n        }\n      }\n    }\n  }\n\n  public untransform() {\n    for (let [classType, map] of super.entries()) {\n      for (let [key, value] of map.entries()) {\n        switch (value.type) {\n        case 'query':\n          if (typeof value.sql === 'string') {\n            Reflect.defineProperty(classType.prototype, key, {\n              value: value.fn\n            })\n          }\n          break\n        case 'transcation':\n          if (typeof value.sql === 'string') {\n            Reflect.defineProperty(classType.prototype, key, {\n              value: value.fn\n            })\n          }\n          break\n        }\n      }\n    }\n  }\n}\n\nexport function Query(sql: string): PropertyDecorator {\n  return function (target: Repository, propertyKey: PropertyKey) {\n    let classType = target.constructor as RepositoryClass\n    if (!PgTemplateContainer.instance.has(classType)) {\n      PgTemplateContainer.instance.set(classType, new Map())\n    }\n    if (!PgTemplateContainer.instance.get(classType).has(propertyKey)) {\n      PgTemplateContainer.instance.get(classType).set(propertyKey, {\n        type: 'query',\n        sql: sql\n      })\n    } else {\n      PgTemplateContainer.instance.get(classType).get(propertyKey).sql = sql\n    }\n  }\n}\n\nexport function QueryFilter<T>(filter: (r: QueryResult) => T): PropertyDecorator {\n  return function (target: Object, propertyKey: PropertyKey) {\n    let classType = target.constructor as RepositoryClass\n    if (!PgTemplateContainer.instance.has(classType)) {\n      PgTemplateContainer.instance.set(classType, new Map())\n    }\n    if (!PgTemplateContainer.instance.get(classType).has(propertyKey)) {\n      PgTemplateContainer.instance.get(classType).set(propertyKey, {\n        type: 'query',\n        filter: filter\n      })\n    } else {\n      PgTemplateContainer.instance.get(classType).get(propertyKey).filter = filter\n    }\n  }\n}\n\nexport function Transaction(sql: string): PropertyDecorator {\n  return function (target: Object, propertyKey: PropertyKey) {\n    let classType = target.constructor as RepositoryClass\n    if (!PgTemplateContainer.instance.has(classType)) {\n      PgTemplateContainer.instance.set(classType, new Map())\n    }\n    if (!PgTemplateContainer.instance.get(classType).has(propertyKey)) {\n      PgTemplateContainer.instance.get(classType).set(propertyKey, {\n        type: 'transcation',\n        sql: sql\n      })\n    } else {\n      PgTemplateContainer.instance.get(classType).get(propertyKey).sql = sql\n    }\n  }\n}\n\nexport function TransactionFilter<T>(filter: (r: ReadonlyArray<QueryResult>) => T): PropertyDecorator {\n  return function (target: Object, propertyKey: PropertyKey) {\n    let classType = target.constructor as RepositoryClass\n    if (!PgTemplateContainer.instance.has(classType)) {\n      PgTemplateContainer.instance.set(classType, new Map())\n    }\n    if (!PgTemplateContainer.instance.get(classType).has(propertyKey)) {\n      PgTemplateContainer.instance.get(classType).set(propertyKey, {\n        type: 'transcation',\n        filter: filter\n      })\n    } else {\n      PgTemplateContainer.instance.get(classType).get(propertyKey).filter = filter\n    }\n  }\n}\n"]}